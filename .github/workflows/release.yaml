name: release
run-name: Pypi releasing
on: 
  workflow_dispatch: 
  push: 
   branches:
    - master
   tags: 
    - v0.1.**
  
permissions:
  contents: read
  pull-requests: read

jobs:
 builds:
  strategy:
   matrix:
    python: [3.7]
    os: [ubuntu-latest, windows-latest, macos-latest]
    include:
     - os: ubuntu-latest
       protoc: linux-x86_64
     - os: windows-latest
       protoc: win64
     - os: macos-latest
       protoc: osx-x86_64

  runs-on: ${{ matrix.os }}
  steps:
   - name: checkout
     uses: actions/checkout@v3

   - name: check python version
     uses: actions/setup-python@v4
     with:
      python-version: ${{ matrix.python }}
   - name: install maturin
     run: pip install maturin

   - name: get protoc
     run: curl -o protoc.zip https://github.com/protocolbuffers/protobuf/releases/download/v21.11/protoc-21.11-${{matrix.protoc}}.zip

   - name: unzip protoc
     run: unzip protoc.zip

   - name: build
     run: maturin build --release --features ffi_py